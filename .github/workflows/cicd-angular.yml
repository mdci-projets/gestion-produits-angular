name: CI/CD Angular avec Cypress

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: ğŸ” Lint, Test & Cypress
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout du Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Installer les DÃ©pendances
        run: npm ci

      - name: ğŸ” VÃ©rification du Code (Lint)
        run: npx eslint src/

      - name: ğŸ› ï¸ Lancer les Tests Unitaires
        run: npm run test -- --watch=false --browsers=ChromeHeadless

      - name: ğŸŒ DÃ©marrer l'Application en Mode Test
        run: npm run start &  # Lancer l'application Angular en arriÃ¨re-plan
        env:
          CYPRESS_BASE_URL: http://localhost:4300  # Assurez-vous que c'est l'URL correcte

      - name: â³ Attendre que l'Application Soit PrÃªte
        run: sleep 10 # Attendez quelques secondes pour Ãªtre sÃ»r que l'app est prÃªte

      - name: âœ… ExÃ©cuter les Tests E2E avec Cypress
        uses: cypress-io/github-action@v6
        with:
          start: npm run start  # DÃ©marrer Angular avant les tests
          wait-on: 'http://localhost:4300'  # Attendre que l'application soit prÃªte
          browser: chrome  # ExÃ©cuter les tests sur Chrome

  cd:
    name: ğŸš€ Build & Deploy
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout du Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Se Connecter Ã  AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸŒ RÃ©cupÃ©rer l'IP Publique de l'EC2
        id: get-ec2-ip
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=spring-boot-ec2" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)

          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "ğŸ”¹ L'IP publique de l'EC2 est : $PUBLIC_IP"

      - name: ğŸ› ï¸ Modifier `config.json` pour Injecter l'IP du Backend
        run: |
          jq '.productsApiUrl = "http://'$PUBLIC_IP':8080"' public/assets/config.json > public/assets/config_tmp.json
          mv public/assets/config_tmp.json public/assets/config.json
          echo "âœ… URL du Backend injectÃ©e : http://$PUBLIC_IP:8080"

      - name: ğŸ—ï¸ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Installer les DÃ©pendances
        run: npm ci

      - name: ğŸ—ï¸ Construire l'Application
        run: npm run build -- --configuration=production

      - name: ğŸš€ DÃ©ploiement sur GitHub Pages
        if: success()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist/fronted-angular/browser
          clean: true